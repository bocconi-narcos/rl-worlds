# VJEPA2 Model Component Tests

This directory contains several Python unit tests designed to investigate the behavior of specific components and mechanisms within the VJEPA2 (Visual Joint Embedding Predictive Architecture - version 2) model implementation. These tests were created to diagnose issues related to auxiliary loss effectiveness and target encoder convergence.

## Test Suites

The following test suites have been added:

1.  **`test_vjepa2_aux_loss.py`**:
    *   **Purpose:** To test the behavior of the auxiliary loss function (e.g., `VICRegLoss`) when applied in the VJEPA2 context.
    *   **Key Checks:**
        *   Verifies that the auxiliary loss (specifically `VICRegLoss`) can generate a non-zero scalar loss value when given a single input tensor (simulating `online_s_t_emb` from the VJEPA2's online encoder).
        *   Ensures that this loss can produce non-vanishing gradients with respect to its input.
        *   Includes a variation to test `VICRegLoss` behavior with two inputs where one is detached.
    *   **Relevance:** Addresses hypotheses about the fundamental capability of the auxiliary loss to produce learning signals.

2.  **`test_vjepa2_gradient_flow.py`**:
    *   **Purpose:** To ensure that gradients generated by the auxiliary loss correctly flow back to the parameters of the `online_encoder` in the full JEPA model (when set to "vjepa2" mode).
    *   **Key Checks:**
        *   Instantiates the full JEPA model.
        *   Calculates auxiliary loss based on `online_s_t_emb`.
        *   Performs a backward pass from this auxiliary loss.
        *   Asserts that `online_encoder` parameters receive non-None and non-vanishing gradients.
        *   Asserts that `predictor` and `target_encoder` parameters do *not* receive gradients from this specific loss path, as expected.
    *   **Relevance:** Addresses hypotheses about whether the auxiliary loss gradients can reach the intended model components.

3.  **`test_vjepa2_loss_combination.py`**:
    *   **Purpose:** To examine the impact of the auxiliary loss weight when the auxiliary loss is combined with the main JEPA prediction loss.
    *   **Key Checks:**
        *   Calculates gradients for the `online_encoder` under different scenarios:
            *   Main prediction loss only.
            *   Auxiliary loss only (with a representative weight).
            *   Combined loss with a very low auxiliary loss weight.
            *   Combined loss with a significant auxiliary loss weight.
        *   Compares the norms of the resulting gradients.
        *   Asserts that a low-weighted auxiliary loss has minimal impact on the total gradient, while a significantly weighted one noticeably alters the gradient.
    *   **Relevance:** Addresses hypotheses about the relative strength of the auxiliary loss signal when combined with the primary learning objective.

4.  **`test_jepa_ema_update.py`**:
    *   **Purpose:** To verify the correctness of the Exponential Moving Average (EMA) update mechanism for the `target_encoder`.
    *   **Key Checks:**
        *   Modifies `online_encoder` parameters.
        *   Calls the EMA update method (`perform_ema_update`).
        *   Asserts that `target_encoder` parameters are updated according to the EMA formula: `target_new = decay * target_old + (1 - decay) * online_new`.
        *   Verifies that repeated EMA updates cause the `target_encoder` to track changes in the `online_encoder` and move closer to it if the `online_encoder` is static.
    *   **Relevance:** Serves as a sanity check for the target network update logic, relevant to observations about target encoder convergence.

## Running the Tests

These tests are implemented using Python's `unittest` framework. They can typically be run from the root directory of the project using a command like:

```bash
python -m unittest discover tests
```
or more specifically for a single file:
```bash
python -m unittest tests.test_vjepa2_aux_loss # (or other specific test files)
```

Ensure that all necessary dependencies (e.g., `torch`, `einops`) are installed in your Python environment. The tests assume that the `src` directory is in the Python path.
